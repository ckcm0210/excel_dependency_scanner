# Excel Dependency Scanner - 功能分析報告

## 🎯 核心功能概覽

### **主要功能分類**
1. **依賴關係分析** - 追蹤 Excel 儲存格間的依賴關係
2. **外部檔案引用處理** - 解析跨檔案的連結和引用
3. **公式解析與顯示** - 智能解析和美化公式顯示
4. **範圍分析** - 對儲存格範圍進行統計分析
5. **視覺化展示** - 樹狀結構顯示依賴關係

---

## 📊 詳細功能分析

### **A. 依賴關係分析引擎**

#### **1. 單一儲存格分析**
```python
# 功能：分析指定儲存格的所有依賴
def trace_dependency_vine(task, working_path):
    # 支援的引用類型：
    # - 同工作表引用: A1, B2
    # - 同檔案跨工作表: Sheet2!A1
    # - 外部檔案引用: [File.xlsx]Sheet!A1
    # - INDIRECT 動態引用: INDIRECT("A"&B1)
```

**支援的依賴類型**：
- ✅ 直接儲存格引用 (`A1`, `B2:C5`)
- ✅ 工作表間引用 (`Sheet2!A1`)
- ✅ 外部檔案引用 (`[File.xlsx]Sheet!A1`)
- ✅ 命名範圍引用
- ✅ INDIRECT 函數動態引用
- ✅ 陣列公式 (ArrayFormula)

#### **2. 遞歸依賴追蹤**
```python
# 功能：深度優先搜索所有依賴層級
def process_task_recursively():
    # 特性：
    # - 循環引用檢測
    # - 無限深度追蹤
    # - 智能去重
    # - 按公式順序排序
```

**追蹤特性**：
- 🔄 **循環引用檢測**: 自動檢測並停止無限循環
- 📊 **統計報告**: 追蹤唯一節點數量
- 🎯 **智能排序**: 按公式中出現順序排列依賴

### **B. 外部檔案引用處理**

#### **1. 數字路徑解析**
```python
# 問題：Excel 內部使用數字索引 [4] 代表外部檔案
# 解決：自動轉換為實際路徑
# [4]GDP11!$C$9 → 'C:\path\[File.xlsx]'GDP11!$C$9
```

**處理流程**：
1. **檢測數字索引**: 識別 `[數字]` 格式
2. **查找外部連結**: 從 `wb._external_links` 獲取映射
3. **路徑重建**: 轉換為完整檔案路徑
4. **公式重寫**: 更新顯示內容

#### **2. 跨檔案依賴追蹤**
```python
# 功能：無縫追蹤跨多個 Excel 檔案的依賴
# 支援：相對路徑和絕對路徑
# 處理：檔案不存在的錯誤情況
```

### **C. 公式解析與顯示**

#### **1. 智能公式解析**
```python
# 支援的公式類型：
# - 標準公式: =A1+B2
# - 陣列公式: {=SUM(A1:A10*B1:B10)}
# - INDIRECT: =INDIRECT("A"&ROW())
# - 外部引用: =[File.xlsx]Sheet!A1
```

#### **2. 多層級顯示**
```python
# 顯示層級：
# 1. 原始公式 (⚙️ Formula:)
# 2. 計算結果 (📊 Result:)
# 3. 依賴樹狀結構
```

### **D. 範圍分析功能**

#### **1. 自動範圍檢測**
```python
if isinstance(cell_obj, tuple):
    # 檢測到範圍地址 (如 A1:C5)
    rows = len(cell_obj)
    cols = len(cell_obj[0])
```

#### **2. 統計分析**
```python
# 數值統計
total_sum = 0
numeric_cells_count = 0

# 內容分類
error_cells_count = 0    # #REF!, #VALUE! 等
text_cells_count = 0     # 文字內容

# 內容指紋
sha256_hash = hashlib.sha256(content.encode('utf-8')).hexdigest()
```

#### **3. 智能摘要**
```python
# 顯示格式：
# [5R x 3C] [Sum: 1,234.56] [Hash: a1b2c3d4...]
# [10R x 2C] [Errors: 3] [Hash: b2c3d4e5...]
# [3R x 4C] [Text] [Hash: c3d4e5f6...]
```

### **E. INDIRECT 函數特殊處理**

#### **1. 動態引用解析**
```python
# 處理複雜的 INDIRECT 公式：
# =INDIRECT("'C:\path\[File.xlsx]Sheet'!"&A1)
# 
# 解析步驟：
# 1. 提取字面量和儲存格引用
# 2. 計算儲存格值
# 3. 組合最終引用字串
# 4. 解析目標檔案和位置
```

#### **2. 錯誤處理**
```python
# 處理 INDIRECT 解析失敗：
# - 檔案不存在
# - 工作表不存在
# - 儲存格引用無效
# 顯示警告訊息而不中斷分析
```

---

## 🎨 視覺化與用戶體驗

### **A. 樹狀結構顯示**

#### **1. 階層式展示**
```
📍 [File.xlsx]Test!A1
⚙️ Formula: =GDP11!$C$9+F1
📊 Result: 1388
├─ F1: 888
└─ [File2.xlsx]GDP11!C9: 500
   └─ ⚙️ Formula: =D10/C5-1
      📊 Result: 1.53
      ├─ D10: 460
      └─ C5: 300
```

#### **2. 智能顯示模式**
- **Simple**: 同檔案內只顯示儲存格地址
- **Detail**: 總是顯示完整檔案名
- **Full Path**: 顯示完整檔案路徑

### **B. 色彩編碼系統**

#### **1. 語法高亮**
- 🔵 **公式內容**: 藍色顯示
- 🟢 **外部引用**: 深綠色標示
- 🔴 **錯誤訊息**: 紅色粗體
- 🟣 **循環引用**: 紫色斜體
- 🟠 **數值統計**: 橙色顯示

#### **2. 特殊標記**
- 📍 **節點標記**: 標示依賴節點
- ⚙️ **公式標記**: 標示公式內容
- 📊 **結果標記**: 標示計算結果
- 🔷 **特性標記**: 標示範圍特性

---

## ⚡ 效能優化功能

### **A. 檔案快取系統**
```python
# 全局快取避免重複載入
_file_cache = {
    "file_path_False_False": workbook_formula_mode,
    "file_path_True_False": workbook_data_mode,
    "file_path_False_True": workbook_resolved_mode
}
```

### **B. 智能記憶體管理**
```python
# 自動清理機制
def clear_file_cache():
    # 掃描完成後自動釋放記憶體
    # 避免記憶體洩漏
```

---

## 🔧 技術特性

### **A. 多模式檔案讀取**
- **Formula Mode** (`data_only=False`): 讀取公式
- **Data Mode** (`data_only=True`): 讀取計算值
- **Resolved Mode**: 解析數字路徑的公式

### **B. 錯誤處理機制**
- **檔案不存在**: 顯示錯誤訊息繼續分析
- **工作表不存在**: 跳過無效引用
- **公式解析失敗**: 顯示原始公式
- **循環引用**: 檢測並停止無限遞歸

### **C. 相容性支援**
- **Excel 版本**: 支援 .xlsx, .xlsm 格式
- **公式類型**: 支援標準公式和陣列公式
- **引用格式**: 支援各種引用語法
- **特殊函數**: 特別優化 INDIRECT 處理

---

## 📈 使用場景

### **A. 日常使用**
1. **公式除錯**: 快速找到公式錯誤源頭
2. **依賴分析**: 了解儲存格間的關聯性
3. **影響評估**: 修改前評估影響範圍
4. **檔案整理**: 清理無用的外部連結

### **B. 專業應用**
1. **模型審計**: 財務模型的依賴關係檢查
2. **風險評估**: 識別關鍵依賴節點
3. **效能優化**: 找出計算瓶頸
4. **文檔化**: 生成依賴關係文檔

### **C. 團隊協作**
1. **知識傳承**: 理解複雜 Excel 模型
2. **品質控制**: 檢查模型一致性
3. **標準化**: 建立最佳實踐
4. **培訓**: 教學複雜公式結構

---

## 🎯 總結

這個 Excel Dependency Scanner 是一個功能完整的依賴分析工具，具備：

- ✅ **完整的依賴追蹤**: 支援所有類型的 Excel 引用
- ✅ **智能錯誤處理**: 優雅處理各種異常情況
- ✅ **高效能設計**: 快取機制和記憶體優化
- ✅ **直觀的視覺化**: 清晰的樹狀結構顯示
- ✅ **專業級功能**: 支援複雜的企業級 Excel 模型

適合從個人用戶到企業級應用的各種場景。